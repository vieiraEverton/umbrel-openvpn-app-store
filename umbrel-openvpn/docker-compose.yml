---
version: "2.1"
services:
  openvpn-as:
    image: openvpn/openvpn-as
    container_name: openvpn-as
    devices:
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      - MKNOD
    ports:
      - 9943:943
      - 9443:443
      - 1194:1194/udp
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Sao_Paulo
      - APP_PASSWORD=${APP_PASSWORD}
    volumes:
       - ${APP_DATA_DIR}/umbrel-openvpn:/openvpn
    restart: always
    command: >
      sh -c '
        /usr/local/openvpn_as/scripts/openvpnas --nodaemon &
        # espera o serviÃ§o ficar operacional
        for i in $(seq 1 60); do
          /usr/local/openvpn_as/scripts/sacli ConfigQuery >/dev/null 2>&1 && break
          sleep 2
        done
        # aplica a senha que o Umbrel gerou
        /usr/local/openvpn_as/scripts/sacli --user "openvpn" --new_pass "$APP_PASSWORD" SetLocalPassword || true
        wait -n
      '

  web:
    image: nginx:alpine
    depends_on:
      - openvpn-as
    command: >
      sh -c '
        cat >/etc/nginx/conf.d/umbrel.conf <<EOF
        server {
          listen 943;
      
          location = / {
            root /usr/share/nginx/html;
            try_files /index.html =404;
          }

          location = /creds.txt {
            root /usr/share/nginx/html;
            add_header Cache-Control "no-store";
          }

          # tudo mais -> proxy para o Client UI HTTPS
          location / {
            proxy_pass https://openvpn-as:9943;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_ssl_server_name on;
            proxy_ssl_verify off;
          }
        }
        EOF
        && nginx -g "daemon off;"
      '
    restart: always
