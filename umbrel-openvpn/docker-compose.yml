---
version: "2.1"
services:
  openvpn-as:
    image: openvpn/openvpn-as
    container_name: openvpn-as
    devices:
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      - MKNOD
    ports:
      - 9943:943
      - 9443:443
      - 1194:1194/udp
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/Sao_Paulo
      - OVPN_AS_ADMIN_USER=openvpn
    volumes:
       - ${APP_DATA_DIR}/umbrel-openvpn:/usr/share/nginx/html:ro
    restart: always

  web:
    image: nginx:alpine
    depends_on:
      - openvpn-as
    command: >
      sh -c '
        cat >/etc/nginx/conf.d/umbrel.conf <<EOF
        server {
          listen 943;
      
          location = / {
            root /usr/share/nginx/html;
            try_files /index.html =404;
          }

          location = /creds.txt {
            root /usr/share/nginx/html;
            add_header Cache-Control "no-store";
          }

          # tudo mais -> proxy para o Client UI HTTPS
          location / {
            proxy_pass https://openvpn-as:9943;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_ssl_server_name on;
            proxy_ssl_verify off;
          }
        }
        EOF
        && nginx -g "daemon off;"
      '
    volumes:
      - ${APP_DATA_DIR}/config/.admin-pass:/usr/share/nginx/html/creds.txt:ro
    restart: always
